<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Agosto-Septiembre 2025</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95);
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); padding: 30px;
        }
        h1 { text-align: center; color: #333; margin-bottom: 30px; font-size: 2.5em; }
        .status-bar { text-align: center; margin-bottom: 20px; padding: 10px; border-radius: 10px; font-weight: bold; }
        .status-connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .calendar-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .calendar { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); border: 2px solid #e0e0e0; }
        .month-title { text-align: center; font-size: 1.5em; margin-bottom: 15px; color: #667eea; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .day-header { text-align: center; font-weight: bold; padding: 10px; background: #f8f9fa; color: #666; border-radius: 5px; }
        .day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; position: relative; font-weight: 500; }
        .day:hover { background: #e3f2fd; transform: scale(1.05); }
        .day.active { background: #667eea; color: white; }
        .day.holiday { background: #ff6b6b; color: white; }
        .day.has-note { background: #4ecdc4; color: white; }
        .day.has-note::after { content: 'üìù'; position: absolute; bottom: 2px; right: 2px; font-size: 10px; }
        .day.other-month { color: #ccc; cursor: not-allowed; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
        .modal-content { background-color: white; margin: 10% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2); }
        .modal h3 { margin-bottom: 20px; color: #333; text-align: center; }
        .modal textarea { width: 100%; height: 150px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 20px; justify-content: center; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-save { background: #4caf50; color: white; }
        .btn-save:hover:not(:disabled) { background: #45a049; }
        .btn-delete { background: #f44336; color: white; }
        .btn-delete:hover:not(:disabled) { background: #d32f2f; }
        .btn-cancel { background: #9e9e9e; color: white; }
        .btn-cancel:hover { background: #757575; }
        .legend { display: flex; justify-content: center; gap: 30px; margin-top: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-weight: 500; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .calendar-container { grid-template-columns: 1fr; gap: 20px; } .container { padding: 15px; } h1 { font-size: 2em; } .legend { gap: 15px; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ Calendario Agosto - Septiembre 2025</h1>
        <div id="statusBar" class="status-bar status-disconnected">üîÑ Conectando con Firebase...</div>
        <div class="calendar-container">
            <div class="calendar"><div class="month-title">Agosto 2025</div><div class="calendar-grid" id="august-calendar"></div></div>
            <div class="calendar"><div class="month-title">Septiembre 2025</div><div class="calendar-grid" id="september-calendar"></div></div>
        </div>
        <div class="legend">
            <div class="legend-item"><div class="legend-color" style="background: #667eea;"></div><span>D√≠a seleccionado</span></div>
            <div class="legend-item"><div class="legend-color" style="background: #ff6b6b;"></div><span>D√≠as festivos</span></div>
            <div class="legend-item"><div class="legend-color" style="background: #4ecdc4;"></div><span>Con nota</span></div>
        </div>
    </div>

    <!-- Modal para notas -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Nota para el d√≠a</h3>
            <textarea id="noteText" placeholder="Escribe tu nota aqu√≠..."></textarea>
            <div class="modal-buttons">
                <button class="btn btn-save" id="saveBtn" onclick="saveNote()">
                    <span id="saveText">üíæ Guardar</span>
                    <span id="saveSpinner" class="loading-spinner" style="display: none;"></span>
                </button>
                <button class="btn btn-delete" id="deleteBtn" onclick="deleteNote()">üóëÔ∏è Eliminar</button>
                <button class="btn btn-cancel" onclick="closeModal()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de contrase√±a -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>Introduce la contrase√±a</h3>
            <input type="password" id="passwordInput" placeholder="Contrase√±a" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px;">
            <div class="modal-buttons">
                <button class="btn btn-save" onclick="confirmPassword()">‚úÖ Aceptar</button>
                <button class="btn btn-cancel" onclick="cancelPassword()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBscrhDCN1zWUIkQ49uKitCw_z0ppNoN5I",
            authDomain: "pagosyaru.firebaseapp.com",
            projectId: "pagosyaru",
            storageBucket: "pagosyaru.firebasestorage.app",
            messagingSenderId: "788387817886",
            appId: "1:788387817886:web:d9546cd91afc0b5d5d8e8f"
        };

        let app, db, isFirebaseConnected = false;
        try { app = initializeApp(firebaseConfig); db = getFirestore(app); isFirebaseConnected = true; updateStatus('‚úÖ Conectado a Firebase', 'connected'); }
        catch (error) { console.error('Error al conectar con Firebase:', error); updateStatus('‚ùå Error de conexi√≥n - Usando modo offline', 'disconnected'); }

        window.db = db; window.isFirebaseConnected = isFirebaseConnected;

        const holidays = { '2025-08-07': 'Batalla de Boyac√°', '2025-08-18': 'Asunci√≥n de la Virgen (trasladado)', '2025-09-15': 'D√≠a de la Independencia (trasladado)' };
        let notes = {}; let selectedDate = null; const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

        // üîë Contrase√±a fija
        const APP_PASSWORD = "7852"; 
        let pendingAction = null;

        // Funciones Firebase
        window.saveNoteToFirebase = async function(date, noteText) {
            if (!isFirebaseConnected) {
                const localNotes = JSON.parse(localStorage.getItem('calendar-notes') || '{}');
                if (noteText.trim()) { localNotes[date] = noteText; } else { delete localNotes[date]; }
                localStorage.setItem('calendar-notes', JSON.stringify(localNotes)); return true;
            }
            try {
                if (noteText.trim()) { await setDoc(doc(db, 'calendar-notes', date), { text: noteText, timestamp: new Date().toISOString() }); }
                else { await deleteDoc(doc(db, 'calendar-notes', date)); }
                return true;
            } catch (error) { console.error('Error guardando en Firebase:', error); throw error; }
        };

        window.loadNoteFromFirebase = async function(date) {
            if (!isFirebaseConnected) { const localNotes = JSON.parse(localStorage.getItem('calendar-notes') || '{}'); return localNotes[date] || null; }
            try { const docRef = doc(db, 'calendar-notes', date); const docSnap = await getDoc(docRef); return docSnap.exists() ? docSnap.data().text : null; }
            catch (error) { console.error('Error cargando desde Firebase:', error); return null; }
        };

        window.loadAllNotesFromFirebase = async function() {
            if (!isFirebaseConnected) return JSON.parse(localStorage.getItem('calendar-notes') || '{}');
            try {
                const allNotes = {};
                onSnapshot(collection(db, 'calendar-notes'), (querySnapshot) => {
                    querySnapshot.forEach((doc) => { allNotes[doc.id] = doc.data().text; notes[doc.id] = doc.data().text; });
                    updateAllDaysDisplay();
                });
                return allNotes;
            } catch (error) { console.error('Error cargando todas las notas:', error); return {}; }
        };

        // UI
        function updateStatus(message, type) { const statusBar = document.getElementById('statusBar'); statusBar.textContent = message; statusBar.className = `status-bar status-${type}`; }
        function setButtonLoading(buttonId, loading) { const button = document.getElementById(buttonId); const text = document.getElementById(buttonId.replace('Btn', 'Text')); const spinner = document.getElementById(buttonId.replace('Btn', 'Spinner')); button.disabled = loading; if (text) text.style.display = loading ? 'none' : 'inline'; if (spinner) spinner.style.display = loading ? 'inline-block' : 'none'; }

        function generateCalendar(year, month, containerId) {
            const container = document.getElementById(containerId); const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const startDate = new Date(firstDay); startDate.setDate(startDate.getDate() - firstDay.getDay());
            container.innerHTML = ''; dayNames.forEach(day => { const dayHeader = document.createElement('div'); dayHeader.className = 'day-header'; dayHeader.textContent = day; container.appendChild(dayHeader); });
            const currentDate = new Date(startDate);
            for (let i = 0; i < 42; i++) { const dayElement = document.createElement('div'); dayElement.className = 'day'; dayElement.textContent = currentDate.getDate(); const dateString = currentDate.toISOString().split('T')[0]; dayElement.setAttribute('data-date', dateString);
                if (currentDate.getMonth() !== month) { dayElement.classList.add('other-month'); }
                else { dayElement.addEventListener('click', () => openModal(dateString)); if (holidays[dateString]) { dayElement.classList.add('holiday'); dayElement.title = holidays[dateString]; } if (notes[dateString]) { dayElement.classList.add('has-note'); } }
                container.appendChild(dayElement); currentDate.setDate(currentDate.getDate() + 1); }
        }
        function updateDayDisplay(date) { const dayElements = document.querySelectorAll(`[data-date="${date}"]`); dayElements.forEach(dayEl => { if (notes[date]) { dayEl.classList.add('has-note'); } else { dayEl.classList.remove('has-note'); } }); }
        function updateAllDaysDisplay() { Object.keys(notes).forEach(date => updateDayDisplay(date)); }

        // Modal notas
        window.openModal = async function(date) {
            selectedDate = date; const modal = document.getElementById('noteModal'); const title = document.getElementById('modal-title'); const noteText = document.getElementById('noteText');
            const dateObj = new Date(date + 'T00:00:00'); const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }; title.textContent = `Nota para ${dateObj.toLocaleDateString('es-ES', options)}`;
            try { const existingNote = await loadNoteFromFirebase(date); noteText.value = existingNote || ''; } catch (error) { noteText.value = notes[date] || ''; }
            modal.style.display = 'block';
        };
        window.closeModal = function() { document.getElementById('noteModal').style.display = 'none'; selectedDate = null; };

        // üîí Funciones de contrase√±a
        window.requestPassword = function(action) { pendingAction = action; document.getElementById('passwordInput').value = ''; document.getElementById('passwordModal').style.display = 'block'; };
        window.confirmPassword = function() { const input = document.getElementById('passwordInput').value; if (input === APP_PASSWORD) { document.getElementById('passwordModal').style.display = 'none'; if (pendingAction === 'save') proceedSaveNote(); else if (pendingAction === 'delete') proceedDeleteNote(); pendingAction = null; } else { alert("‚ùå Contrase√±a incorrecta"); } };
        window.cancelPassword = function() { document.getElementById('passwordModal').style.display = 'none'; pendingAction = null; };

        // Guardar y eliminar con password
        window.saveNote = function() { requestPassword('save'); };
        window.deleteNote = function() { requestPassword('delete'); };

        async function proceedSaveNote() {
            const noteTextElement = document.getElementById('noteText'); const noteText = noteTextElement.value; if (!selectedDate) return;
            setButtonLoading('saveBtn', true);
            try { await saveNoteToFirebase(selectedDate, noteText); if (noteText.trim()) { notes[selectedDate] = noteText; } else { delete notes[selectedDate]; } updateDayDisplay(selectedDate); alert('¬°Nota guardada correctamente!'); closeModal(); }
            catch (error) { alert('Error al guardar la nota. Int√©ntalo de nuevo.'); }
            finally { setButtonLoading('saveBtn', false); }
        }
        async function proceedDeleteNote() {
            if (!selectedDate || !notes[selectedDate]) return; setButtonLoading('deleteBtn', true);
            try { await saveNoteToFirebase(selectedDate, ''); delete notes[selectedDate]; updateDayDisplay(selectedDate); alert('¬°Nota eliminada correctamente!'); closeModal(); }
            catch (error) { alert('Error al eliminar la nota. Int√©ntalo de nuevo.'); }
            finally { setButtonLoading('deleteBtn', false); }
        }

        // Eventos
        window.onclick = function(event) { const noteModal = document.getElementById('noteModal'); const passwordModal = document.getElementById('passwordModal'); if (event.target === noteModal) closeModal(); if (event.target === passwordModal) cancelPassword(); };
        document.addEventListener('keydown', function(event) { const passwordModal = document.getElementById('passwordModal'); const noteModal = document.getElementById('noteModal'); if (event.key === 'Escape') { if (passwordModal.style.display === 'block') cancelPassword(); else if (noteModal.style.display === 'block') closeModal(); } if (event.key === 'Enter' && passwordModal.style.display === 'block') confirmPassword(); });

        document.addEventListener('DOMContentLoaded', async function() { generateCalendar(2025, 7, 'august-calendar'); generateCalendar(2025, 8, 'september-calendar'); try { notes = await loadAllNotesFromFirebase(); updateAllDaysDisplay(); } catch (error) { console.error('Error cargando notas:', error); } });
    </script>
</body>
</html>
